name: Publish to ESP Component Registry

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ç‰ˆæœ¬æ ‡ç­¾ï¼ˆå¦‚ v1.0.3ï¼‰æ—¶è§¦å‘
  release:
    types: [published]  # å½“åˆ›å»º Release æ—¶è§¦å‘

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™ä»¥åˆ›å»º Release
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verify idf_component.yml
        run: |
          echo "æ£€æŸ¥ idf_component.yml æ–‡ä»¶..."
          if [ ! -f "idf_component.yml" ]; then
            echo "âŒ é”™è¯¯: idf_component.yml æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… idf_component.yml æ–‡ä»¶å­˜åœ¨"
          cat idf_component.yml

      - name: Extract version
        id: get_version
        run: |
          if [ -n "${{ github.event.release.tag_name }}" ]; then
            VERSION=${GITHUB_EVENT_RELEASE_TAG_NAME#v}
          elif [ -n "${{ github.ref }}" ] && [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/v}
          else
            VERSION=$(grep '^version:' idf_component.yml | awk '{print $2}' | tr -d '"' | tr -d "'")
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ ç‰ˆæœ¬: $VERSION"

      - name: Create Release if not exists
        if: github.event_name == 'push'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG_NAME="${{ github.ref_name }}"
          VERSION="${{ steps.get_version.outputs.version }}"
          
          # æ£€æŸ¥ Release æ˜¯å¦å·²å­˜åœ¨
          if curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/txp666/otto-emoji-gif-component/releases/tags/$TAG_NAME" | grep -q '"id"'; then
            echo "âœ… Release $TAG_NAME å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
          else
            echo "ðŸ“¦ åˆ›å»º Release $TAG_NAME..."
            curl -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              "https://api.github.com/repos/txp666/otto-emoji-gif-component/releases" \
              -d "{
                \"tag_name\": \"$TAG_NAME\",
                \"name\": \"ç‰ˆæœ¬ $VERSION\",
                \"body\": \"ç‰ˆæœ¬ $VERSION\\n\\nç»„ä»¶å°†è‡ªåŠ¨åŒæ­¥åˆ° ESP Component Registryã€‚\\n\\næŸ¥çœ‹ç»„ä»¶: https://components.espressif.com/components/txp666/otto-emoji-gif-component\",
                \"draft\": false,
                \"prerelease\": false
              }"
          fi

      - name: Trigger ESP Registry Sync
        env:
          IDF_COMPONENT_API_TOKEN: ${{ secrets.IDF_COMPONENT_API_TOKEN }}
        run: |
          echo "ðŸ”„ è§¦å‘ ESP Component Registry åŒæ­¥..."
          
          if [ -n "$IDF_COMPONENT_API_TOKEN" ]; then
            echo "ä½¿ç”¨ API Token è¿›è¡ŒåŒæ­¥..."
            # å¦‚æžœæœ‰ Tokenï¼Œå¯ä»¥å°è¯•é€šè¿‡ API è§¦å‘åŒæ­¥
            curl -X POST \
              -H "Authorization: Bearer $IDF_COMPONENT_API_TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.components.espressif.com/v1/webhooks/github" \
              -d "{\"repository\": \"txp666/otto-emoji-gif-component\", \"tag\": \"${{ github.ref_name }}\"}" \
              || echo "âš ï¸  API è°ƒç”¨å¤±è´¥ï¼Œå°†é€šè¿‡è‡ªåŠ¨æ‰«æåŒæ­¥"
          else
            echo "â„¹ï¸  IDF_COMPONENT_API_TOKEN æœªè®¾ç½®"
            echo "ç»„ä»¶å°†é€šè¿‡ ESP Component Registry çš„è‡ªåŠ¨æ‰«æåŒæ­¥ï¼ˆé€šå¸¸éœ€è¦å‡ åˆ†é’Ÿåˆ°å‡ å°æ—¶ï¼‰"
            echo "èŽ·å– Token: https://components.espressif.com/ ç™»å½•åŽ -> è®¾ç½® -> Tokens"
          fi

      - name: Summary
        run: |
          echo "## ðŸ“¦ ç»„ä»¶å‘å¸ƒä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ä»“åº“**: https://github.com/txp666/otto-emoji-gif-component" >> $GITHUB_STEP_SUMMARY
          echo "- **ç»„ä»¶é“¾æŽ¥**: https://components.espressif.com/components/txp666/otto-emoji-gif-component" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ç»„ä»¶å°†è‡ªåŠ¨åŒæ­¥åˆ° ESP Component Registryï¼Œè¯·ç¨åŽæŸ¥çœ‹ã€‚" >> $GITHUB_STEP_SUMMARY

